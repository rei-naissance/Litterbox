{% load custom_filters %}
{% load static %}

<div class="w-1/5 fixed right-10 border border-border-gray rounded-3xl">
  {% if post.image and post.image.url %}
    <img src="{{ post.image.url }}" alt="Post image" class="object-cover h-full w-full rounded-3xl"/>
  {% else %}
    <img src="{% static '/images/default_image.jpg' %}" alt="Default Image" class="object-cover h-full w-full rounded-3xl" />
  {% endif %}
</div>

<div>
  <div class="p-6 pb-1">
    <div class="flex justify-between">
      <div class="flex space-x-3 mb-4 w-full items-center">
        <div class="w-9 h-9 rounded-full bg-gray-300"></div>
        <div class="font-bold">{{ post.author }}</div>
        <div class="text-gray-font">{{ post.date_posted|timesince_first }}</div>
      </div>
      <div class="relative">
        <!-- Dots Button -->
        <button
          type="button"
          class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100"
          onclick="toggleDropdown('{{ post.id }}')"
        >
          {% include "assets/dots.svg" %}
        </button>
      
        <!-- Dropdown Menu -->
        <div id="dropdown-{{ post.id }}" class="hidden absolute right-0 mt-2 w-32 bg-white border border-gray-300 rounded-lg shadow-lg z-10">
          <!-- Edit Option -->
          <a
            href=""
            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            Edit
          </a>
      
          <!-- Report Option -->
          <a
            href="{% url 'send_report' post.id %}"
            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
          >
            Report
          </a>
        </div>
      </div>
    </div>

    
    <h1 class="text-2xl font-bold mb-4">{{ post.title }}</h1>
    <p class="mb-4">{{ post.content }}</p>

    <div class="px-4 pl-0 py-2 flex justify-between text-xs mb-4">
      <div class="flex items-center">
        <button class="text-gray-font flex items-center cursor-pointer" onclick="toggleLike('{{ post.id }}')">
          <div class="mx-2 ml-0" id="like-svg-{{ post.id }}">
            {% if user_liked %}
              {% include "assets/heart-filled.svg" %}
            {% else %}
              {% include "assets/ph_heart-bold.svg" %}
            {% endif %}
          </div>
          <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span
        >
        <span class="mx-4 text-gray-font flex">
          <div class="mx-2">{% include "assets/iconamoon_comment.svg" %}</div>
          {{ post.comments.count }}</span
        >
        <span class="text-gray-font flex">
          <div class="mx-2">{% include "assets/uil_share.svg" %}</div>
          0</span
        >
      </div>
      <div class="flex items-center">
        <span class="text-gray-font">0 min read</span>
        <button class="text-gray-font   flex items-center" onclick="toggleSave('{{ post.id }}')">
        <div class="ml-6" id="save-svg-{{ post.id }}">
          {% if user_saved %}
            {% include "assets/bookmark.svg" %}
          {% else %}
            {% include "assets/material-symbols_bookmark-outline.svg" %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
<div class="w-full">
    <div>
      {% if post.comments.count > 0 %}
      <div class="w-full px-6 mb-4">
        <hr/>
      </div>
    <h1 class="text-md font-bold pb-4 px-6 border border-x-0 border-t-0 border-b-border-gray">
      Replies
    </h1>
    {% endif %}

    <ul class="">
      {% for comment in comments %}
      <li class="px-6 py-4 space-y-1 border border-x-0 border-t-0 border-b-border-gray">
        <div class="flex space-x-2">
          <div class="font-bold">{{ comment.author }}</div>
          <div class="text-gray-font">{{ comment.date_posted|timesince_first }}</div>
        </div>
        <p>{{ comment.content }}</p>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>
</div>

<script>
  function toggleDropdown(id) {
  const dropdown = document.getElementById(`dropdown-${id}`);
  
  if (dropdown) {
    dropdown.classList.toggle('hidden');
    dropdown.classList.toggle('block');

    if (!dropdown.classList.contains('hidden')) {
      // Add a document listener to close the dropdown
      document.addEventListener('click', (event) => closeOnClickOutside(event, id));
    }
  } else {
    console.error(`Dropdown with ID 'dropdown-${id}' not found.`);
  }
}

function closeOnClickOutside(event, id) {
  const dropdown = document.getElementById(`dropdown-${id}`);
  const button = document.querySelector(`[onclick="toggleDropdown('${id}')"]`);
  
  if (dropdown && !dropdown.contains(event.target) && !button.contains(event.target)) {
    dropdown.classList.add('hidden');
    dropdown.classList.remove('block');
    
    // Remove the document listener after closing
    document.removeEventListener('click', (e) => closeOnClickOutside(e, id));
  }
}
function toggleLike(postId) {
    fetch(`/toggle-like/${postId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      // Like toggling with json to avoid reload
      const likeCount = document.querySelector(`#like-count-${postId}`);
      const likeSvg = document.querySelector(`#like-svg-${postId}`);
      likeCount.textContent = data.like_count;
      likeSvg.innerHTML = data.liked
      ? `{% include "assets/heart-filled.svg" %}`
      : `{% include "assets/ph_heart-bold.svg" %}`;
    })
    .catch(error => console.error('Error:', error));
  }

  function toggleSave(postId) {
    fetch(`/toggle-save/${postId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      const saveSvg = document.querySelector(`#save-svg-${postId}`);
      saveSvg.innerHTML = data.saved
      ? `{% include "assets/bookmark.svg" %}`
      : `{% include "assets/material-symbols_bookmark-outline.svg" %}`;
    })
    .catch(error => console.error('Error:', error));
  }

</script>